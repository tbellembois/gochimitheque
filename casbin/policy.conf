
[request_definition]
r = person_id, action, item, item_id

[policy_definition]
p = person_id, perm, item, entity_id


[policy_effect]
e = some(where (p.eft == allow))

# 1. -> admins have full privileges
# 2. permission matching:
# the policy action match the request action
# or if the action is read the policy can be r or w or all
# or if the action is write the policy can be w or all
# or if the action is all the policy must be all (redondant with the first sentence but we keep it for readability)
# AND
# 3. -> permissions on products just require the policy on products (item is always all)
# 4. -> request to read any (at least one) entity requires policy for at least one entity or all items
# (actually everybody has this permission given that each user can read its own entity)
#    -> request to read a specific entity requires to be member of the entity
#    -> request to write a specitic entity requires to have policy to write all entites (admin)
# 5. -> request to read/write any (at least one) storage requires policy for at least one storage or all
#    -> request to read/write a specific storage requires to be member of the same entity as the storage store location
# 6. -> request to read any (at least one) store location requires policy of at least one storage or all
#    -> request to read a specific store location requires policy for storage and to be member of the same entity as the store location
#    -> request to write any (at least one) store location requires policy of at least one entity or all
#    -> request to write a specific store location requires policy for entity and to be member of the same entity as the store location

[matchers]
m = (r.person_id == p.person_id) \
&& (( \
      (p.perm == "all" && p.item == "all" && p.entity_id == "-1") \
      \
    || ( \
        (r.action == p.perm \
        || (r.action == "r" && (p.perm == "w" || p.perm == "all")) \
        || (r.action == "w" && p.perm == "all") \
        || (r.action == "all" && p.perm == "all")) \
        && ( \
             ((r.item == "products" \
             || r.item == "bookmarks" \
             || r.item == "download" \
             || r.item == "validate") && (p.item == "products" || p.item =="all")) \
          \
          || (r.item == "entities" && r.action == "r" && (r.item_id == "-2" || r.item_id == "") && (p.item == "entities" || p.item =="all")) \
          || (r.item == "entities" && r.action == "r" && (r.item_id != "-2" && r.item_id != "") && matchEntity(r.person_id, r.item_id)) \
          || (r.item == "entities" && r.action == "w" && r.item_id == p.entity_id && (p.item == "entities" || p.item =="all")) \
          \
          || ((r.item == "storages" || r.item == "stocks" ||  r.item == "borrows") && (r.item_id == "-2" || r.item_id == "") && (p.item == "storages" || p.item =="all")) \
          || ((r.item == "storages" || r.item == "stocks" ||  r.item == "borrows") && (r.item_id != "-2" && r.item_id != "") && matchStorage(r.person_id, r.item_id, p.entity_id)) \
          \
          || (r.item == "store_locations" && r.action == "r" && (r.item_id == "-2" || r.item_id == "") && (p.item == "storages" || p.item =="all")) \
          || (r.item == "store_locations" && r.action == "r" && (r.item_id != "-2" && r.item_id != "") && matchStorelocation(r.person_id, r.item_id, p.entity_id)) \
          || (r.item == "store_locations" && r.action == "w" && (r.item_id == "-2" || r.item_id == "") && (p.item == "entities" || p.item =="all")) \
          || (r.item == "store_locations" && r.action == "w" && (r.item_id != "-2" && r.item_id != "") && matchStorelocation(r.person_id, r.item_id, p.entity_id)) \
          \
          || (r.item == "people" && r.action == "r" && (r.item_id == "-2" || r.item_id == "") && (p.item == "entities" || p.item =="all")) \
          || (r.item == "people" && r.action == "r" && (r.item_id != "-2" && r.item_id != "") && matchPeople(r.person_id, r.item_id, p.entity_id)) \
          || (r.item == "people" && r.action == "w" && (r.item_id == "-2" || r.item_id == "") && (p.item == "entities" || p.item =="all")) \
          || (r.item == "people" && r.action == "w" && (r.item_id != "-2" && r.item_id != "") && matchPeople(r.person_id, r.item_id, p.entity_id)) \
          ) \
       ) \
   ) \
  || \
  (r.item == "userinfo") || \
  (r.item == "ping"))
