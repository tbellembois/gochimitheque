
[request_definition]
r = person_id, action, item, item_id

# action = r,w,all or d (d permission is not in the database)

[policy_definition]
p = person_id, perm, item, entity_id

[policy_effect]
e = some(where (p.eft == allow))

# 1. -> admins have full privileges
# 2. permission matching:
# the policy action match the request action
# or if the action is read the policy can be r or w or all
# or if the action is write the policy can be w or all
# or if the action is all the policy must be all (redondant with the first sentence but we keep it for readability)
# AND
# 3. -> can not delete a product with storages
#    -> permissions on products just require the policy on products (item is always all)
# 4. -> request to read any (at least one) entity requires policy for at least one entity or all items
# (actually everybody has this permission given that each user can read its own entity)
#    -> request to read a specific entity requires to be member of the entity
#    -> request to write/delete a specitic entity requires to have policy to write all entites (admin)
# 5. -> request to read/write/delete any (at least one) storage requires policy for at least one storage or all
#    -> request to read/write/delete a specific storage requires to be member of the same entity as the storage store location
# 6. -> request to read any (at least one) store location requires policy of at least one storage or all
#    -> request to read a specific store location requires policy for storage and to be member of the same entity as the store location
#    -> request to write/delete any (at least one) store location requires policy of at least one entity or all
#    -> request to write/delete a specific store location requires policy for entity and to be member of the same entity as the store location
# 7. -> request to read any (at least one) person requires policy of at least one entity or all
#    -> request to read a specific person (except oneself) requires policy for entity and to be member of the same entity as the person
#    -> can not delete oneself oan admin or a manager
#    -> request to write/delete any (at least one) person requires policy of at least one entity or all
#    -> request to write/delete a specific person (except oneself) requires policy for entity and to be member of the same entity as the person

[matchers]
m = (r.person_id == p.person_id) \
&&
( \
   ( \
      (p.perm == "all" && p.item == "all" && p.entity_id == "-1") \
      \
      || ( \
           (r.action == p.perm \
          || (r.action == "r" && (p.perm == "w" || p.perm == "all")) \
          || ((r.action == "w" || r.action == "d") && p.perm == "all") \
          || (r.action == "all" && p.perm == "all") \
        ) \
      && ( \
            ((r.item == "bookmarks" || r.item == "download" || r.item == "validate") && (p.item == "products" || p.item =="all")) \
            \
            || (r.item == "products" && r.action == "d" && ! matchProductHasStorages(r.item_id)) \
            || (r.item == "products" && (p.item == "products" || p.item =="all")) \
            \
            || (r.item == "entities" && r.action == "r" &&  r.item_id == "" && (p.item == "entities" || p.item =="all")) \
            || (r.item == "entities" && r.action == "r" &&  r.item_id != "" && matchPersonIsInEntity(r.person_id, r.item_id)) \
            || (r.item == "entities" && r.action == "d" && r.item_id == p.entity_id && (p.item == "entities" || p.item =="all") && ! matchEntityHasMembers(r.item_id) && ! matchEntityHasStoreLocations(r.item_id))\
            || (r.item == "entities" && (r.action == "w" || r.action == "d") && r.item_id == p.entity_id && (p.item == "entities" || p.item =="all")) \
            \
            || (r.item == "storages" || (r.item == "stocks" ||  r.item == "borrows") &&  r.item_id == "" && (p.item == "storages" || p.item =="all")) \
            || (r.item == "storages" || (r.item == "stocks" ||  r.item == "borrows") &&  r.item_id != "" && matchPersonIsInStorageEntity(r.person_id, r.item_id, p.entity_id)) \
            \
            || (r.item == "store_locations" && r.action == "r" && r.item_id == "" && (p.item == "storages" || p.item =="all")) \
            || (r.item == "store_locations" && r.action == "r" && r.item_id != "" && matchPersonIsInStoreLocationEntity(r.person_id, r.item_id, p.entity_id)) \
            || (r.item == "store_locations" && r.action == "d" && r.item_id != "" && (p.item == "entities" || p.item =="all")) && (! matchStoreLocationHasChildren(r.item_id) && ! matchStoreLocationHasStorages(r.item_id)) \
            || (r.item == "store_locations" && (r.action == "w" || r.action == "d") &&  r.item_id == "" && (p.item == "entities" || p.item =="all")) \
            || (r.item == "store_locations" && (r.action == "w" || r.action == "d") &&  r.item_id != "" && matchPersonIsInStoreLocationEntity(r.person_id, r.item_id, p.entity_id)) \
            \
            || (r.item == "people" && r.action == "r" &&  r.item_id == "" && (p.item == "entities" || p.item =="all")) \
            || (r.item == "people" && r.action == "r" && (r.item_id != p.person_id) && r.item_id != "" && matchPersonIsInPersonEntity(r.person_id, r.item_id, p.entity_id)) \
            || (r.item == "people" && r.action == "d" && r.item_id != "" && (p.item == "entities" || p.item =="all")) && ((r.item_id != p.person_id) && ! matchPersonIsAdmin(r.person_id) && ! matchPersonIsManager(r.person_id))\
            || (r.item == "people" && (r.action == "w" || r.action == "d") && r.item_id == "" && (p.item == "entities" || p.item =="all")) \
            || (r.item == "people" && (r.action == "w" || r.action == "d") && (r.item_id != p.person_id) &&  r.item_id != "" && matchPersonIsInPersonEntity(r.person_id, r.item_id)) \
        ) \
    ) \
) \
|| \
(r.item == "userinfo") \
|| \
(r.item == "ping") \
)
