version: '3.8'
services:
    nginx:
        container_name: nginx
        image: nginx:1.25
        restart: unless-stopped
        ports:
            - 443:443
            - 80:80
        volumes:
            - /data/docker-nginx/nginx-auth/certs:/etc/nginx/certs
            - /data/docker-nginx/nginx-templates:/etc/nginx/templates
        networks:
            - chimitheque
        depends_on:
            - keycloak
            - chimitheque

    postgres:
        container_name: postgres
        image: postgres:16
        restart: unless-stopped
        environment:
            POSTGRES_USER: postgres
            POSTGRES_PASSWORD: postgres
            POSTGRES_DB: keycloak
        networks:
            - chimitheque
        volumes:
            - /data/docker-postgres/data:/var/lib/postgresql/data

    keycloak:
        container_name: keycloak
        restart: unless-stopped
        depends_on:
            - postgres
        ports:
            - 8080:8080
        build:
            context: ./docker/keycloak
            dockerfile: Dockerfile
            args:
                KC_DB: postgres
                KC_DB_URL: jdbc:postgresql://postgres:5432/keycloak
                KC_DB_USERNAME: postgres
                KC_DB_PASSWORD: postgres
                KC_HOSTNAME: localhost:8080
                KC_FEATURES: docker
                KC_HTTP_RELATIVE_PATH: /keycloak
                KC_HOSTNAME_STRICT_HTTPS: false
                KC_PROXY: edge
        entrypoint: "/opt/keycloak/bin/kc.sh start --optimized"
        #entrypoint: "/opt/keycloak/bin/kc.sh export --dir /tmp/keycloak --users realm_file --realm chimitheque"
        environment:
            - KEYCLOAK_ADMIN=chimitheque
            - KEYCLOAK_ADMIN_PASSWORD=chimitheque
            - PROXY_ADDRESS_FORWARDING=true
        # volumes:
        #     - /tmp/keycloak:/tmp/keycloak
        networks:
            - chimitheque

    chimitheque:
        container_name: chimitheque
        # Always choose the "production" image.
        # development
        #image: tbellembois/gochimitheque:latest
        # production
        image: tbellembois/gochimitheque:2.1.0
        restart: unless-stopped
        environment:
            # enable debug logs - not recommended in production
            - CHIMITHEQUE_DEBUG=false
            # application path, with a trailing /
            - CHIMITHEQUE_APPPATH=/chimitheque/
            # application url
            - CHIMITHEQUE_APPURL=http://localhost:8081
            # you should not have any reason to change this
            - CHIMITHEQUE_DOCKERPORT=8081
            # OIDC issuer URL
            - CHIMITHEQUE_OIDCDISCOVERYURL=http://localhost:8080/keycloak/realms/master/.well-known/openid-configuration
            # OIDC client ID
            - CHIMITHEQUE_OIDCCLIENTID=chimitheque
            # OIDC client secret
            - CHIMITHEQUE_OIDCCLIENTSECRET=mysupersecret
            # list of admins
            - CHIMITHEQUE_ADMINS=bob@foo.com,bar@foo.com
            # one shot command: update storages QR codes
            # - CHIMITHEQUE_UPDATEQRCODE=true
        volumes:
            - /data/docker-chimitheque/chimitheque-db:/data
        networks:
            - chimitheque

networks:
    chimitheque: