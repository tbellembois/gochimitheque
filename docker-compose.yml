version: '3.8'
services:
    nginx:
        container_name: nginx
        image: nginx:1.25
        restart: unless-stopped
        ports:
            - 443:443
            - 80:80
        volumes:
            - /data/docker-nginx/nginx-auth/certs:/etc/nginx/certs
            - /data/docker-nginx/nginx-templates:/etc/nginx/templates
        networks:
            - chimitheque
        depends_on:
            - casdoor
            - chimitheque
    casdoor:
        container_name: casdoor
        image: casbin/casdoor:v1.454.0
        restart: unless-stopped
        entrypoint: /bin/sh -c './server'
        # entrypoint: /bin/sh -c './server --createDatabase=true'
        # ports:
        #     - "8000:8000"
        environment:
            - RUNNING_IN_DOCKER=true
            - httpport=8000
            - runmode=dev
            - driverName=sqlite
            - dataSourceName=file:/data/casdoor.db?cache=shared
            - dbName=casdoor
            - showSql=true
            - origin=http://172.20.82.36
        volumes:
            - /data/docker-casdoor/casdoor-db:/data
            - /data/docker-casdoor/casdoor-init/init_data.json:/init_data.json:ro
        networks:
            - chimitheque
    chimitheque:
        container_name: chimitheque
        # Always choose the "production" image.
        # development
        #image: tbellembois/gochimitheque:latest
        # production
        image: tbellembois/gochimitheque:2.1.0
        restart: unless-stopped
        environment:
            # enable debug logs - not recommended in production
            - CHIMITHEQUE_DEBUG=true
            # application path, with a trailing /
            - CHIMITHEQUE_APPPATH=/chimitheque/
            # application url
            - CHIMITHEQUE_APPURL=http://172.20.82.36
            # you should not have any reason to change this
            - CHIMITHEQUE_DOCKERPORT=8081
            # OIDC issuer URL
            - CHIMITHEQUE_OIDCISSUER=http://172.20.82.36
            # OIDC client ID
            - CHIMITHEQUE_OIDCCLIENTID=chimitheque
            # OIDC client secret
            - CHIMITHEQUE_OIDCCLIENTSECRET=chimitheque
            # share your product database
            - CHIMITHEQUE_ENABLEPUBLICPRODUCTSENDPOINT=true
            # initial autoimport URL
            - CHIMITHEQUE_AUTOIMPORT_URL=https://chimitheque.ens-lyon.fr
            # list of admins
            - CHIMITHEQUE_ADMINS=bob@foo.com,bar@foo.com
            # one shot command: update storages QR codes
            # - CHIMITHEQUE_UPDATEQRCODE=true
        volumes:
            - /data/docker-chimitheque/chimitheque-db:/data
        networks:
            - chimitheque
networks:
    chimitheque: