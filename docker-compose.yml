services:
    nginx:
        container_name: nginx
        image: nginx:1.25
        restart: unless-stopped
        ports:
            - 443:443
            - 80:80
        volumes:
            - /data/docker-nginx/nginx-auth/certs:/etc/nginx/certs
            - /data/docker-nginx/nginx-templates:/etc/nginx/templates
            - /data/docker-nginx/nginx-conf/nginx.conf:/etc/nginx/nginx.conf:ro
        networks:
            - chimitheque
        depends_on:
            - keycloak
            - chimitheque

    postgres:
        container_name: postgres
        image: postgres:16
        restart: unless-stopped
        environment:
            POSTGRES_USER: postgres
            POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
            POSTGRES_DB: keycloak
        networks:
            - chimitheque
        volumes:
            - /data/docker-postgres/data:/var/lib/postgresql/data

    keycloakpre:
        container_name: keycloakpre
        image: ubuntu:kinetic
        environment:
            - CHIMITHEQUE_APPURL=${CHIMITHEQUE_APPURL}
            - CHIMITHEQUE_OIDCCLIENTSECRET=${CHIMITHEQUE_OIDCCLIENTSECRET}
        command: >
            bash -c "echo $CHIMITHEQUE_APPURL &&
                     echo $CHIMITHEQUE_OIDCCLIENTSECRET &&
                     sed 's CHIMITHEQUE_APPURL $CHIMITHEQUE_APPURL g; s CHIMITHEQUE_OIDCCLIENTSECRET $CHIMITHEQUE_OIDCCLIENTSECRET g' /data/chimitheque-realm-template.json > /data/chimitheque-realm.json"
        volumes:
            - /data/docker-keycloak/import:/data
        networks:
            - chimitheque

    keycloak:
        container_name: keycloak
        restart: unless-stopped
        depends_on:
            - postgres
        ports:
            - 8080:8080
        build:
            context: ./docker/keycloak
            dockerfile: Dockerfile
            args:
                KC_DB: postgres
                KC_DB_URL: jdbc:postgresql://postgres:5432/keycloak
                KC_DB_USERNAME: postgres
                KC_DB_PASSWORD: ${POSTGRES_PASSWORD}
                KC_HOSTNAME: ${KEYCLOAK_HOSTNAME}
                KC_FEATURES: docker
                KC_HTTP_RELATIVE_PATH: /keycloak
                KC_HOSTNAME_STRICT_HTTPS: ${KEYCLOAK_HOSTNAME_STRICT_HTTPS}
                KC_PROXY: edge
                KC_PROXY_HEADERS: forwarded
        entrypoint: "/opt/keycloak/bin/kc.sh start --optimized --import-realm"
        # keycloak export REALM command
        #entrypoint: "/opt/keycloak/bin/kc.sh export --dir /opt/keycloak/data/import --users realm_file --realm chimitheque --optimized"
        environment:
            - KEYCLOAK_ADMIN=chimitheque
            - KEYCLOAK_ADMIN_PASSWORD=${KEYCLOAK_ADMIN_PASSWORD}
            - PROXY_ADDRESS_FORWARDING=true
        volumes:
            - /data/docker-keycloak/import:/opt/keycloak/data/import
        networks:
            - chimitheque

    chimitheque:
        container_name: chimitheque
        image: ${CHIMITHEQUE_IMAGE}
        restart: unless-stopped
        environment:
            - CHIMITHEQUE_DEBUG=${CHIMITHEQUE_DEBUG}
            - CHIMITHEQUE_APPPATH=/chimitheque/
            - CHIMITHEQUE_APPURL=${CHIMITHEQUE_APPURL}
            - CHIMITHEQUE_DOCKERPORT=8081
            - CHIMITHEQUE_OIDCDISCOVERURL=${KEYCLOAK_SCHEME}://${KEYCLOAK_HOSTNAME}/keycloak/realms/master/.well-known/openid-configuration
            - CHIMITHEQUE_OIDCCLIENTID=chimitheque
            - CHIMITHEQUE_OIDCCLIENTSECRET=${CHIMITHEQUE_OIDCCLIENTSECRET}
            - CHIMITHEQUE_ADMINS=${CHIMITHEQUE_ADMINS}
            # - CHIMITHEQUE_UPDATEQRCODE=true
        volumes:
            - /data/docker-chimitheque/chimitheque-db:/data
        networks:
            - chimitheque

networks:
    chimitheque: